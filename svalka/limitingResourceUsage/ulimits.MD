Управление ограничениями ресурсов POSIX

- Изменение рантайм ограничений с помощью ulimit
    * Применяется к шелу, в котором запущена команда
- Применение постоянных ограничений в /etc/security/limits.conf
- Мягкие ограничений могут быть изхменены пользователем, жесткие - абсолютная граница, потолок
    * Пользователи могут устанавливать мягкие ограничения но не выше значений жестких.

- В этом уроке мы поговорим об установке ограничений ресурсов с помощью ulimit. Ulimit - это старый способ установки лимитов. Он применяется к шелу, в котором запущена команда. Чтобы выставить постоянные настройки ulimit, нужно отредактировать файл /etc/security/limits.conf. Мягкие ограничения могут быть изменены пользователем. Жесткие ограничения это абсолютная граница, потолок.

Управление постоянными лимитами

- Для управления постоянными ограничениями используется модуль pam_limits.
- Он работает с файлами /etc/security/limits.conf и /etc/security/limits.d/*.conf
- man 5 limits.conf для документации
    * Обрати внимание, не все ограничения в настоящее время работают, например rss
- Пример: установить максимальное количество входов в систему для студентов, равное двум, создав файл в /etc/security/limits/students.d и следующим содержимым:
    * @students hard maxlogins 2

Для управления постоянными ограничений используется модуль pam_limits. pam_limits применяется из сеанса PAM для настройки постоянных ограничений и работает с /etc/security/limits.conf, а также с .conf файлами из директории /etc/security/limits.d. Для получения дополнительной информации вы можете проверить страницу справочника, которая является limit.conf. Вы должны заметить, что не все ограничения в настоящее время работают. Например, предел rss не работает.
Например, если вы хотите установить постоянное ограничение с помощью этого механизма, вы можете установить максимальное количество входов в систему для студентов, равное двум, создав файл с содержимым /etc/security/limits/students.d и следующим содержимым:
```
    * @students hard maxlogins 2
```
который установит жесткое ограничение на максимальное количество логинов в два для всех, кто является членом группы студентов.


Установка ограничений для служб

- Добавить записи Limit * в блок [Service] файла модуля, чтобы ограничить возможности сервисов.
- In systemd units, add the Limit* entries to the [Service] block of a unit file to limit what services can do
- Если, например, вы хотите, чтобы ваш сервис с именем blah.service не превышал 60 секунд процессорного времени, нужно добавить следующее в /etc/systemd/system/blah.service.d/10-cpulimits.conf:
    [Service]
    LimitCPU=60


В среде systemd вы также можете установить ограничения для сервисов. Для этого вы можете добавить записи Limit * в блок [Service] файла модуля, чтобы ограничить возможности сервисов.
Я упомянул Limit* на слайде, что означает, что есть несколько ограничений, которые могут быть применены. Если, например, вы хотите, чтобы ваш сервис с именем blah.service не превышал 60 секунд процессорного времени, прежде чем он был убит, вы должны добавить следующее в /etc/systemd/system/blah.service.d/10-cpulimits.conf:
    [Service]
    LimitCPU=60
Обратите внимание, что при таком подходе в текущий файл модуля добавляется файл для blah.service, поэтому предполагается, что где-то еще в конфигурации systemd в вашей системе есть blah.service. После внесения этого изменения убедитесь, что вы используете systemctl daemon-reload, а также systemctl blah restart, чтобы изменения вступили в силу.

PAM - это Pluggable Authentication Modules

- PAM интегрируется в процедуру входа в систему.
- Есть этот общий файл PAM system_auth
- в system_auth есть определение session
- в определение session вызывается pam_limits
- pam_limits - это файл библиотеки. Поскольку этот файл интегрируется в system_auth и взаимодействует с PAM, то все, что открывается в shell'e, проходит аутентификацию и будет использовать ulimit

Итак, ulimit исходит от PAM. PAM - это Pluggable Authentication Modules (PAM), и она интегрируется в процедуру входа в систему. Есть этот общий файл PAM, system_auth, а в system_auth есть определение session. И в этом определении вызывается pam_limits. Это файл библиотеки, и поскольку этот файл библиотеки интегрируется в system_auth и взаимодействует с PAM, то все, что открывается в shell'e, проходит аутентификацию и будет использовать ulimit, потому что PAM в свою очередь используется процедурой входа в систему, используется su итд.

И в результате, если вы создадите этот файл limit.conf в /etc/security, все ограничения, которые вы определяете в файле limit.conf через PAM, применяются ко всему, что использует PAM.

В случае, если вы не захотите его использовать, вам нужно перейти в файл конфигурации PAM system_auth и просто удалить pam_limits.so, и он больше не будет использоваться.

Теперь давайте посмотрим на ulimits. ulimits начинаются с /etc/pam.d/, потому что /etc/pam.d/ - это то место, где их можно указать. Давайте выполним grep pam_limits, чтобы увидеть, что system-auth требует pam_limits.so
```
[root@postgres mtuktarov]# grep pam_limits -rn /etc/pam.d
/etc/pam.d/fingerprint-auth:16:session     required      pam_limits.so
/etc/pam.d/password-auth:15:session     required      pam_limits.so
/etc/pam.d/smartcard-auth:16:session     required      pam_limits.so
/etc/pam.d/system-auth:15:session     required      pam_limits.so
/etc/pam.d/runuser:4:session        required    pam_limits.so
```

Давайте посмотрим, что еще лежит в этом файле конфигурации, чтобы иметь предстовление о том что такое PAM получше, потому что это вещи, с которыми не каждый работает ежедневно. Итак, PAM - это набор подгружаемых модулей, которые определяют, что происходит, когда пользователи входят в систему. Мы здесь в system_auth. system_auth - это файл конфигурации, который используется всем, что относится к входу в систему.
В файле конфигурации мы видим три столбца и четыре разных раздела.

Auth определяет, что должно происходить, когда пользователь входит в систему.
Account определяет, что происходит, когда пользователь получает доступ к ресурсам. Здесь, например, можно указать, что пользователь с конкретным MAC адресом не имеет доступа.
Passwords связаны с паролями.
Session - это то, что используется для дальнейшего формирования сеанса, в который пользователи будут входить. И session есть установка, что нужно подходить под все критерии, которые реалтзованы в файле библиотеки pam_limits.so

В свою очередь этот файл библиотеки pam_limits.so читает конфигурацию из /etc/security/limits.conf и связанной поддиректории. Теперь давайте перейдем в /etc/security/limit.conf. Здесь можно найти довольно приличное объяснение и примеры.
domains - указывают, к кому это относится. Как правило, это имя пользователя или группы.
type - soft или hard. Обычно устанавливают жесткий лимит. Мягкий используется для того, чтобы дать пользователю немного дополнительного пространства, если это может потребоваться.
items - это то, чем можно оперировать. Как видите, можно ограничивать разные вещи.

Ниже примеры того, как устанавливать ограничения.

Файл конфигурации находится в /etc/security/limits.conf
В директории /etc/security/limit.d находятя файлы оснастки, которые будут добавлены в конфигурацию. В нашем случае это ограничивает количество процессов для всех пользователей, кроме root.
Надо отметить, что ulimits - это довольно старый механизм, но он все еще актуален, потому что некоторые ограничения могут быть установлены только через ulimits.

Теперь давайте посмотрим, как вы можете установить ограничения для сервисов.
man systemd.exec
